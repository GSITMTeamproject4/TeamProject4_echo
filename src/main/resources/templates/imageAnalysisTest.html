<!DOCTYPE html>
<layout:html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml"
             xmlns:layout="http://www.w3.org/1999/xhtml"
             layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teachable Machine with Spring Boot</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>



    <style>


        #containerAll {

            /* 가운데 정렬 */
            text-align: center;
            width: 100%;
            max-width: 1200px; /* 최대 너비 설정 */
            margin: 0 auto; /* 좌우 중앙 정렬을 위한 자동 마진 설정 */
            padding: 20px;
            box-sizing: border-box; /* 패딩과 보더 포함한 전체 요소 너비 설정 */
        }
        /* 파일 선택(input)과 분석 버튼(button)의 스타일 */
        #image-upload {
            display: inline-block;
            vertical-align: top;
            margin-right: 20px; /* 파일 선택(input)의 오른쪽 마진 */
            padding:3px;
        }

        .btn-success {
            vertical-align: top;
        }

        #preview-container {

            display: block;
            width: 500px;
           height: 200px;
            margin: 0 auto 15px;
            overflow: hidden; /* 이미지가 넘칠 경우를 대비하여 overflow 설정 */
            border: 2px dashed #ccc;
            text-align: center;
            line-height: 200px; /* 이미지 미리보기 박스의 세로 중앙 정렬 */

        }

        #image-preview {
            max-width: 100%;
            max-height: 100%;

        }

        #image-preview-placeholder {
            display: block;
            max-width: 100%;
            max-height: 100%;
            font-size: 16px;
            color: #aaa;
            line-height: 200px; /* 이미지 미리보기 박스의 세로 중앙 정렬 */

        }

        .upload-area {
            margin-bottom: 20px; /* 파일 선택(input) 위의 간격 */
        }
    </style>

</head>
<div layout:fragment="content">
    <body class="blog-page">
    <!--타이틀-->
    <main class="main">
        <div class="page-title" data-aos="fade">
            <div class="heading">
                <div class="container">
<div class="row d-flex justify-content-center text-center">
                        <div class="col-lg-8">
                            <h1>재활용 도우미</h1>
                            <p>이미지 분석을 통해 올바르게 분리수거와 재활용을 도와드립니다.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
<div id="containerAll">
    <div id="preview-container">
        <img id="image-preview" src="#" alt="Image Preview" style="display:none; max-width: 400px; max-height: 500px;">
    </div>
<input type="file" id="image-upload" accept="image/*" onchange="showPreview(event)" class="btn btn-success">

<button type="button" onclick="predict()" class="btn btn-success">Analyze Image</button>
<div id="label-container"></div>
</div>
<script type="text/javascript">
    const URL = "/";

    let model, labelContainer, maxPredictions;

    async function init() {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        labelContainer = document.getElementById("label-container");
        labelContainer.appendChild(document.createElement("div"));
    }

    function showPreview(event) {
        const input = event.target;
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const imgElement = document.getElementById('image-preview');
                imgElement.src = e.target.result;
                imgElement.style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function predict() {
        const imgElement = document.getElementById('image-preview');
        if (imgElement.src && imgElement.src !== "#") {
            const prediction = await model.predict(imgElement);

            let highestPrediction = prediction[0];
            for (let i = 1; i < prediction.length; i++) {
                if (prediction[i].probability > highestPrediction.probability) {
                    highestPrediction = prediction[i];
                }
            }

            labelContainer.childNodes[0].innerHTML = highestPrediction.className;
        } else {
            alert("Please upload an image first.");
        }
    }

    // Initialize the model
    init();


</script>
    </body>
</div>
</layout:html>