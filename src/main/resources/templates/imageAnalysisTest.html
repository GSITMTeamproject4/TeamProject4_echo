<!DOCTYPE html>
<layout:html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml"
             xmlns:layout="http://www.w3.org/1999/xhtml"
             layout:decorate="~{layout}">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Teachable Machine with Spring Boot</title>
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>



        <style>


            #containerAll {

                /* 가운데 정렬 */
                text-align: center;
                width: 100%;
                margin: 0 auto; /* 좌우 중앙 정렬을 위한 자동 마진 설정 */
                padding: 20px;
                box-sizing: border-box; /* 패딩과 보더 포함한 전체 요소 너비 설정 */
            }
            /* 파일 선택(input)과 분석 버튼(button)의 스타일 */
            #image-upload {
                display: inline-block;
                vertical-align: top;
                margin-right: 70px; /* 파일 선택(input)의 오른쪽 마진 */
                padding:3px;

            }

            .btn-success {
                vertical-align: top;
            }

            #preview-container {
                width: 400px;
                height: 300px;
                overflow: hidden; /* 이미지가 넘칠 경우를 대비하여 overflow 설정 */
                border: 2px dashed #ccc;
                text-align: center;
                line-height: 200px; /* 이미지 미리보기 박스의 세로 중앙 정렬 */

            }

            #image-preview {
                max-width: 100%;
                max-height: 100%;
                margin: auto;

            }

            #image-preview-placeholder {
                display: block;
                max-width: 100%;
                max-height: 100%;
                font-size: 16px;
                color: #aaa;
                line-height: 200px; /* 이미지 미리보기 박스의 세로 중앙 정렬 */

            }

            .upload-area {
                margin-bottom: 20px; /* 파일 선택(input) 위의 간격 */
            }
            #label-container {
                text-align: center;
                width:200px;
                height:300px;
                /* 버튼 위에 위치하도록 조정 */
                background-color: #f0f0f0; /* 배경색 설정 */
                line-height: 200px; /* 세로 중앙 정렬을 위한 line-height 설정 */
                color: #333; /* 글자 색상 설정 */
                border: 2px dashed #ccc; /* 테두리 설정 */
            }

            #containerwith {
                display: flex; /* Flexbox 사용 */
                justify-content: center; /* 내부 요소들 가운데 정렬 */
                gap: 20px; /* 요소들 사이의 간격 설정 */
                margin-bottom: 20px; /* 하단 마진 설정 */
            }
            #analyzeImage{
                margin-left:30px;
            }
            .new-class {
                font-weight: bold;
            }
        </style>

    </head>
    <div layout:fragment="content">
        <body class="blog-page">
        <!--타이틀-->
        <main class="main">
            <div class="page-title" data-aos="fade">
                <div class="heading">
                    <div class="container">
                        <div class="row d-flex justify-content-center text-center">
                            <div class="col-lg-8">
                                <h1>재활용 도우미</h1>
                                <p>이미지 분석을 통해 올바른 재활용을 방법을 알고 재활용을 실천할 수 있습니다.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
        <div id="containerAll">
            <div id="containerwith">
            <div id="preview-container">
                <img id="image-preview" src="#" alt="Image Preview" style="display:none; width:400px; height: 300px;">
            </div>
            <div id="label-container" ></div>
                </div>

            <input type="file" id="image-upload" accept="image/*" onchange="showPreview(event)" class="btn btn-success">

            <button type="button" onclick="predict()" class="btn btn-success" id="analyzeImage">Analyze Image</button>


        </div>
        <script type="text/javascript">
            const URL = "/";

            let model, labelContainer, maxPredictions;

            async function init() {
                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";

                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();

                labelContainer = document.getElementById("label-container");
                labelContainer.appendChild(document.createElement("div"));
                const newDiv = document.createElement("div");

                // 클래스 추가
                newDiv.classList.add("new-class");

                // labelContainer에 추가
                labelContainer.appendChild(newDiv);
            }

            function showPreview(event) {
                const input = event.target;
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const imgElement = document.getElementById('image-preview');
                        imgElement.src = e.target.result;
                        imgElement.style.display = 'block';
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            }

            async function predict() {
                const imgElement = document.getElementById('image-preview');
                if (imgElement.src && imgElement.src !== "#") {
                    const prediction = await model.predict(imgElement);

                    let highestPrediction = prediction[0];
                    for (let i = 1; i < prediction.length; i++) {
                        if (prediction[i].probability > highestPrediction.probability) {
                            highestPrediction = prediction[i];
                        }
                    }

                    labelContainer.childNodes[0].innerHTML = highestPrediction.className;

                } else {
                    alert("Please upload an image first.");
                }
            }

            // Initialize the model
            init();


        </script>
        </body>
    </div>
</layout:html>