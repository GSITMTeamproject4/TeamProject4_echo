<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sample Payment</title>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<h2>결제 정보</h2>
<p>총 금액: <span th:text="${totalAmount}"></span>원</p>
<p>구매자 이메일: <span th:text="${buyerEmail}"></span></p>
<p>구매자 이름: <span th:text="${buyerName}"></span></p>
<p>구매자 전화번호: <span th:text="${buyerTel}"></span></p>
<p>구매자 주소: <span th:text="${buyerAddr}"></span></p>
<p>구매자 우편번호: <span th:text="${buyerPostcode}"></span></p>

<button onclick="sendOrderData('ORD' + new Date().getTime(), false)">주문 데이터 전송</button> <!-- 주문 데이터 전송 버튼 생성 -->


<script>

  // 서버에서 전달된 변수들을 JavaScript 변수로 변환
  var productNames = /*[[${productNames}]]*/ [];
  var productIds = /*[[${productIds}]]*/ [];
  var quantities = /*[[${quantities}]]*/ [];
  var totalAmount = /*[[${totalAmount}]]*/ 0;
  var buyerName = /*[[${buyerName}]]*/ '';
  var buyerTel = /*[[${buyerTel}]]*/ '';
  var buyerAddr = /*[[${buyerAddr}]]*/ '';
  var buyerPostcode = /*[[${buyerPostcode}]]*/ '';

  function sendOrderData(merchant_uid, paymentSuccess) {
    // productIds와 quantities가 null일 경우 빈 배열로 처리
    productIds = productIds || [];
    quantities = quantities || [];

    const orderData = JSON.stringify({
      orderNumber: merchant_uid,
      buyerTel: buyerTel,
      buyerAddr: buyerAddr,
      buyerPostcode: buyerPostcode,
      totalAmount: totalAmount,
      items: productIds.map((productId, index) => ({
        productId: productIds[index],
        productName: productNames[index], // 추가된 부분
        quantity: quantities[index]
      })),
      buyerId: buyerName // 추가된 부분
    });

    // 데이터를 콘솔에 출력하여 확인
    console.log("Order Data to be sent:", orderData);

    $.ajax({
      type: 'POST',
      url: '/order/success',
      data: orderData,
      contentType: "application/json",
      success: function(response) {
        console.log("Order data sent successfully:", response);
        // location.href 부분 제거
      },
      error: function(xhr, status, error) {
        console.error("Failed to send order data:", error);
      }
    });
  }

</script>

</body>
</html>
