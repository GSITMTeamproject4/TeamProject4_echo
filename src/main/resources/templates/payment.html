<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- iamport.payment.js -->
  <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
  <script th:inline="javascript">
    var IMP = window.IMP;
    IMP.init("imp24163476");
    var merchant_uid = 'ORD' + new Date().getTime(); // 고유한 주문번호 생성

    // 서버에서 전달된 변수들을 JavaScript 변수로 변환
    var productNames = /*[[${productNames}]]*/ [];
    var productIds = /*[[${productIds}]]*/ [];
    var quantities = /*[[${quantities}]]*/ [];
    var totalAmount = /*[[${totalAmount}]]*/ 0;
    var buyerEmail = /*[[${buyerEmail}]]*/ '';
    var buyerId = /*[[${buyerId}]]*/ '';
    var buyerTel = /*[[${buyerTel}]]*/ '';
    var buyerAddr = /*[[${buyerAddr}]]*/ '';
    var buyerPostcode = /*[[${buyerPostcode}]]*/ '';

    console.log("Product Names:", productNames);
    console.log("Product IDs:", productIds);
    console.log("Quantities:", quantities);
    console.log("Total Amount:", totalAmount);
    console.log("Buyer Email:", buyerEmail);
    console.log("Buyer Name:", buyerId);
    console.log("Buyer Tel:", buyerTel);
    console.log("Buyer Addr:", buyerAddr);
    console.log("Buyer Postcode:", buyerPostcode);


    function requestPay() {

      IMP.request_pay({
        pg: "kakaopay",
        pay_method: "card",
        merchant_uid: merchant_uid,   // 주문번호
        name: productNames.join(", "), // 여러 상품 이름을 쉼표로 구분하여 결제 요청에 포함
        amount: totalAmount,         // 총 금액
        buyer_email: buyerEmail,
        buyer_id: buyerId,
        buyer_tel: buyerTel,
        buyer_addr: buyerAddr,
        buyer_postcode: buyerPostcode
      }, function (rsp) { // callback
        console.log("Payment response:", rsp); // 결제 응답 로그 추가
        if (rsp.success) {
          $.ajax({
            type: 'POST',
            url: 'api/order/verify/' + rsp.imp_uid,
            success: function(data) {
              console.log("Verification response:", data); // 검증 응답 로그 추가
              if (rsp.paid_amount === data.response.amount) {
                alert("결제 성공");
                sendOrderData(merchant_uid, true); // 결제 검증이 끝난 후 주문 데이터를 전송
              } else {
                alert("결제 실패");
                sendOrderData(merchant_uid, false); // 결제 검증 실패 시에도 주문 데이터를 전송
              }
            },
            error: function(request, status, error) {
              console.error("Verification error:", error); // 검증 오류 로그 추가
              alert("결제가 완료되었습니다.");
              sendOrderData(merchant_uid, false); // 결제 검증 실패 시에도 주문 데이터를 전송
            }
          });
        } else {
          console.error("Payment failed:", rsp.error_msg); // 결제 실패 로그 추가
          alert("결제에 실패하였습니다. 에러 내용: " + rsp.error_msg);
        }
      });
    }

    function sendOrderData(merchant_uid, paymentSuccess) {
      // productIds와 quantities가 null일 경우 빈 배열로 처리
      productIds = productIds || [];
      quantities = quantities || [];
      productNames = productNames || [];

      // 데이터가 올바르게 입력되었는지 확인하기 위해 콘솔 로그 추가
      console.log("Product IDs:", productIds);
      console.log("Quantities:", quantities);
      console.log("Product Names:", productNames);
      console.log("Merchant UID:", merchant_uid);
      console.log("Buyer Tel:", buyerTel);
      console.log("Buyer Email:", buyerEmail);
      console.log("Buyer Addr:", buyerAddr);
      console.log("Buyer Postcode:", buyerPostcode);
      console.log("Total Amount:", totalAmount);
      console.log("Buyer ID:", buyerId);

      // JSON으로 변환하기 전에 데이터가 올바른지 확인
      const orderDataObject = {
        orderNumber: merchant_uid,
        buyerTel: buyerTel,
        buyerEmail: buyerEmail,
        buyerAddr: buyerAddr,
        buyerPostcode: buyerPostcode,
        totalAmount: totalAmount,
        items: productIds.map((productId, index) => ({
          productId: productId,
          productName: productNames[index],
          quantity: quantities[index]
        })),
        buyerId: buyerId
      };

      // 변환할 객체를 먼저 로그로 출력하여 확인
      console.log("Order Data Object:", orderDataObject);

      try {
        const orderData = JSON.stringify(orderDataObject);

        // 데이터를 콘솔에 출력하여 확인
        console.log("Order Data to be sent:", orderData);

        var token = $("input[name='_csrf']").val();
        var header = "X-CSRF-TOKEN";
        console.log("CSRF Token:", token); // CSRF 토큰 확인 로그

        $.ajax({
          type: 'POST',
          url: '/api/order/success',
          data: orderData,
          cache: false,
          contentType: 'application/json',
          beforeSend: function(xhr) {
            xhr.setRequestHeader(header, token); // CSRF 토큰 설정
          },
          success: function(response) {
            console.log("Order data sent successfully:", response);
            // 성공 시 페이지 이동
            window.location.href = "/order/success";
          },
          error: function(xhr, status, error) {
            console.error("Failed to send order data:", error);
            console.error("Response Text:", xhr.responseText);
            console.error("Response Status:", status);
            console.error("Response Headers:", xhr.getAllResponseHeaders());
            //window.location.href = "/order/success";
          }
        });
      } catch (e) {
        console.error("JSON.stringify error:", e);
      }
    }

  </script>
  <meta charset="UTF-8">
  <title>Sample Payment</title>
</head>

<body>
<h2>결제 정보</h2>
<p>총 금액: <span th:text="${totalAmount}"></span>원</p>
<p>구매자 이메일: <span th:text="${buyerEmail}"></span></p>
<p>구매자 이름: <span th:text="${buyerName}"></span></p>
<p>구매자 전화번호: <span th:text="${buyerTel}"></span></p>
<p>구매자 주소: <span th:text="${buyerAddr}"></span></p>
<p>구매자 우편번호: <span th:text="${buyerPostcode}"></span></p>
<button onclick="requestPay()">결제하기</button> <!-- 결제하기 버튼 생성 -->
<button onclick="sendOrderData('ORD' + new Date().getTime(), false)">주문 데이터 전송</button> <!-- 주문 데이터 전송 버튼 생성 -->

<!-- CSRF 토큰이 포함된 폼 추가 post 요청할 때 무조건 토큰 있어야 됨-->
<form th:action="@{/api/order/success}" method="post">
  <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
  <!-- 기타 폼 필드 -->
</form>
</body>
</html>
